<!--
این کد متعلق به صاحب اثر است و هرگونه کپی‌برداری، استفاده، تغییر یا انتشار آن بدون اجازه ممنوع است.
-->


<!DOCTYPE html>

<html lang="fa" dir="rtl">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <title>مسابقه‌ی افعال عربی</title>

  <!-- فونت وزیر -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css">

  <style>
    :root{
      --bg: linear-gradient(135deg, #f0f5ff, #e0eaff);
      --panel:#ffffff;
      --accent:#2e7d32;
      --danger:#e53935;
      --muted:#6b7280;
      --card:#eef4ff;
      --success-bg: rgba(46,125,50,0.1);
      --danger-bg: rgba(229,57,53,0.1);
      --highlight: #4caf50;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:"Vazir",system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;color:#0b274b; overscroll-behavior: none;}
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:22px;align-items:start;opacity:0;transform:translateY(6px);transition:opacity 0.5s ease, transform 0.5s ease; padding: 24px;}
    button{cursor:pointer;padding:8px 12px;border-radius:12px;border:0;background:var(--accent);color:#fff;font-weight:600;font-family:"Vazir";transition:background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;}
    button:hover{transform:scale(1.03);background:#256628; box-shadow:0 4px 12px rgba(37,102,40,0.2);}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(46,125,50,0.14);transition:background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;}
    button.ghost:hover{background:rgba(46,125,50,0.1);transform:scale(1.03); box-shadow:0 4px 12px rgba(46,125,50,0.1);}
    button.active {border: 2px solid var(--highlight); background: var(--success-bg);}
    .panel{background:var(--panel);border-radius:16px;padding:20px;box-shadow:0 10px 24px rgba(15,23,42,0.08);transition:transform 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease;opacity:0;transform:translateY(8px); border: 1px solid rgba(0,0,0,0.05);}
    .panel.visible{opacity:1;transform:translateY(0); box-shadow:0 14px 32px rgba(15,23,42,0.1);}
    .question-box{background:linear-gradient(180deg,#e8f7ff,#f4f9ff);border-radius:14px;padding:22px;text-align:center;font-weight:700;font-size:20px;color:#05305a;box-shadow:inset 0 1px 0 rgba(255,255,255,0.6), 0 2px 4px rgba(0,0,0,0.05);transition:background 0.5s ease, transform 0.3s ease, opacity 0.5s ease;}
    .question-box:hover{transform: scale(1.01);}
    .verb{font-size:34px;margin:8px 0;direction:rtl;transition:color 0.3s ease, transform 0.3s ease, opacity 0.5s ease;}
    .answers{display:flex;gap:18px;margin-top:18px;transition:opacity 0.3s ease, transform 0.3s ease;flex-wrap:wrap; animation: fadeIn 0.5s ease;}
    .card{flex:1;background:var(--card);border-radius:12px;padding:22px;text-align:center;cursor:pointer;transition:transform 0.25s ease,box-shadow 0.25s ease,background 0.25s ease, opacity 0.3s ease;user-select:none;position:relative;min-height:110px;display:flex;flex-direction:column;justify-content:center; animation: slideUp 0.4s ease forwards; border: 1px solid rgba(0,0,0,0.03);}
    .card:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 10px 26px rgba(12,40,80,0.06);}
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    .badge{position:absolute;top:-12px;left:-12px;background:var(--accent);color:#fff;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;transition:transform 0.3s ease, opacity 0.3s ease; animation: bounceIn 0.5s ease;}
    .card-text span{display:block;font-size:18px;font-weight:700;line-height:1.5;transition:color 0.3s ease;}
    .card.correct{background:var(--accent);color:#fff;box-shadow:0 10px 26px rgba(46,125,50,0.12);transform:scale(1.05); animation: correctAnim 0.5s ease;}
    .card.wrong{background:var(--danger);color:#fff;box-shadow:0 10px 26px rgba(229,57,53,0.12);transform:scale(1.05); animation: wrongAnim 0.5s ease;}
    /* meta area */
    .meta{display:flex;justify-content:space-between;gap:12px;margin-top:14px;align-items:center;transition:opacity 0.3s ease, transform 0.3s ease; position:relative;}
    .meta .score{font-weight:800;color:var(--accent);font-size:18px; transition: color 0.3s ease; text-align: left;}
    .meta .timer{font-weight:900;color:#05305a;font-size:32px; transition: color 0.3s ease, transform 0.3s ease; flex: none; text-align: center; position:absolute; left:50%; transform:translateX(-50%);}
    .meta .timer.urgent{color:var(--danger); animation: urgentPulse 1s infinite;}
    .meta .details{font-size:13px;color:var(--muted); text-align: right; display: flex; flex-direction: column; align-items: flex-end;}
    .meta .difficulty{font-size:13px;color:var(--muted); text-align: left;}
    /* admin panel grid layout */
    .admin-panel{position:fixed;top:10%;left:50%;transform:translateX(-50%) scale(0.96);background:var(--panel);border-radius:14px;padding:16px;box-shadow:0 18px 40px rgba(15,23,42,0.12);max-width:900px;width:92%;opacity:0;transition:transform 0.36s cubic-bezier(.2,.9,.3,1), opacity 0.36s ease;z-index:3000;display:none}
    .admin-panel.open{display:grid;opacity:1;transform:translateX(-50%) scale(1);grid-template-columns:1fr 320px;gap:12px; animation: fadeIn 0.4s ease;}
    .admin-panel h3{margin:0 0 10px 0;font-size:16px; transition: color 0.3s ease;}
    .admin-left{display:flex;flex-direction:column;gap:10px}
    .admin-right{display:flex;flex-direction:column;gap:10px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    textarea{width:100%;min-height:80px;padding:8px;border-radius:8px;border:1px solid #e6eef8;background:#fbfdff;resize:vertical;transition:border 0.3s ease, box-shadow 0.3s ease;font-family:"Vazir"}
    textarea:focus{border-color:var(--accent); box-shadow:0 0 8px rgba(46,125,50,0.2)}
    .field{margin-bottom:12px}
    .row{display:flex;gap:8px}
    input[type="number"], input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8;transition:border 0.3s ease, box-shadow 0.3s ease;font-family:"Vazir"}
    input[type="number"]:focus, input[type="text"]:focus{border-color:var(--accent); box-shadow:0 0 8px rgba(46,125,50,0.2)}
    .score-list{max-height:320px;overflow:auto;border-radius:8px;background:#fbfdff;padding:8px;border:1px solid #eef6ff;transition:background 0.3s ease}
    .score-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed #eef6ff;transition:background 0.3s ease, transform 0.3s ease;}
    .score-item:hover{background:rgba(46,125,50,0.05); transform: translateX(4px);}
    .footer-actions{display:flex;gap:8px;margin-top:8px}
    .modal{position:fixed;inset:0;background:rgba(3,6,23,0.45);display:none;align-items:center;justify-content:center;padding:20px;transition:opacity 0.3s ease; z-index: 4000;}
    .modal.open{display:flex;opacity:1; animation: fadeInModal 0.4s ease;}
    .modal-card{background:#fff;padding:18px;border-radius:12px;min-width:320px;max-width:520px;transition:transform 0.28s ease;text-align:center; animation: popIn 0.4s ease;}
    .modal-card{transform:scale(0.96)}
    .modal.open .modal-card{transform:scale(1)}
    .muted{color:var(--muted)}
    /* صفحه intro */
    #intro{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;transition:opacity 0.8s ease-in-out, visibility 0.8s; animation: introAnim 1s ease;}
    #intro h1{font-size:48px;margin:0;color:#05305a;transition:transform 0.5s ease, opacity 0.5s ease; animation: fadeIn 1.5s ease-in-out;}
    #intro p{font-size:20px;margin-top:10px;color:var(--muted);transition:transform 0.5s ease, opacity 0.5s ease; animation: fadeIn 1.5s ease-in-out;}
    #intro .skip-hint{margin-top:12px;font-size:13px;color:var(--muted); animation: fadeIn 1.5s ease-in-out;}
    #intro.hidden{opacity:0;visibility:hidden}
    /* پنل شروع بهبود یافته */
    #startPanel {text-align: center; padding: 20px; background: var(--panel); border-radius: 14px; box-shadow: 0 8px 20px rgba(15,23,42,0.06); transition: opacity 0.5s ease, transform 0.5s ease; display: flex; flex-direction: column; align-items: center; justify-content: center;}
    #startPanel #startBtn {padding: 24px 48px; font-size: 28px; border-radius: 12px; box-shadow: 0 4px 12px rgba(46,125,50,0.2);}
    #countdown {display: none; font-size: 48px; font-weight: bold; color: var(--accent); background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); animation: pulse 1s infinite;}
    #controls {display: none; gap: 8px; margin-top: 12px; justify-content: center;}
    @keyframes pulse {0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);}}
    @keyframes fadeIn {from {opacity: 0;} to {opacity: 1;}}
    @keyframes fadeOut {from {opacity: 1;} to {opacity: 0;}}
    @keyframes slideUp {from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);}}
    @keyframes bounceIn {0% {transform: scale(0.5); opacity: 0;} 50% {transform: scale(1.2);} 100% {transform: scale(1); opacity: 1;}}
    @keyframes correctAnim {0% {transform: scale(1); background: var(--card);} 50% {transform: scale(1.1); background: var(--accent);} 100% {transform: scale(1.05); background: var(--accent);}}
    @keyframes wrongAnim {0% {transform: scale(1); background: var(--card);} 50% {transform: scale(1.1) rotate(-3deg); background: var(--danger);} 100% {transform: scale(1.05); background: var(--danger);}}
    @keyframes urgentPulse {0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);}}
    @keyframes slideDown {from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);}}
    @keyframes fadeInModal {from {opacity: 0;} to {opacity: 1;}}
    @keyframes popIn {from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;}}
    @keyframes introAnim {from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);}}
    @media (max-width:1000px){
      .wrap{grid-template-columns:1fr; padding-bottom:40px; padding: 12px;}
      .answers{flex-direction:column; gap: 12px;}
      .admin-panel.open{grid-template-columns:1fr}
      button {padding: 10px 16px; font-size: 16px;}
      .verb {font-size: 28px;}
      .card {min-height: 90px; padding: 16px;}
      #intro h1 {font-size: 36px;}
      #intro p {font-size: 16px;}
      .modal-card {width: 90%;}
    }
    @media (max-width: 600px) {
      body {padding: 8px;}
      .wrap {padding: 8px;}
      .question-box {font-size: 18px; padding: 16px;}
      .meta .timer {font-size: 28px;}
    }
    .touch-friendly {touch-action: manipulation;} /* برای بهبود لمس در موبایل */
    .hearts {display: flex; justify-content: center; gap: 4px; margin-top: 8px;}
    .heart {font-size: 20px; color: var(--danger);}
    .heart.empty {color: var(--muted);}
    .close-btn {display: none; margin-bottom: 12px;}
    @media (max-width: 600px) {
      .close-btn {display: block;}
    }
    /* top error toast */
    .top-error{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:#fff3f3;color:var(--danger);padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);z-index:5000;display:none;font-weight:700}
  </style>

</head>

<body>
<div id="intro" role="dialog" aria-modal="true">
  <h1>بازی وزن افعال عربی روش</h1>
  <p>ساخته شده توسط: محمد محسن بیک | محمد رادمنش</p>
  <p>(دبیرستان صلحا)</p>
  <div class="skip-hint small">برای ادامه صفحه را لمس کنید</div>
</div>

<div class="wrap" aria-live="polite">
  <header style="display:none"></header>
  <main>
    <div class="panel" id="mainPanel" aria-hidden="true">
      <div class="question-box">
        <div>وزن فعل ماضی ( <span id="verbDisplay" class="verb"></span> ) با کدام گروه افعال مضارع زیر تشابه دارد !؟</div>
      </div>
      <div class="answers" id="answers" aria-label="گزینه‌ها">
      </div>

      <div class="meta">
        <div class="score">امتیاز: <span id="score">۰</span></div>
        <div class="timer" id="timeLeft">۰۰:۰۰</div>
        <div class="details">
          <div class="small muted">سوال: <span id="qCount">۰</span> | درست: <span id="correctCount">۰</span> | غلط: <span id="wrongCount">۰</span></div>
          <div class="difficulty">سطح: <span id="difficultyDisplay"></span></div>
        </div>
      </div>

      <div class="hearts" id="hearts" style="display:none;">
        <span class="heart" id="heart1">❤️</span>
        <span class="heart" id="heart2">❤️</span>
        <span class="heart" id="heart3">❤️</span>
      </div>

      <!-- پنل شروع بهبود یافته -->
      <div id="startPanel" style="display:none;">
        <button id="startBtn">شروع بازی</button>
        <div id="countdown"></div>
      </div>

      <div id="controls" style="display:none;gap:8px;margin-top:12px;justify-content:center">
        <button id="pauseBtn" class="ghost" disabled>توقف</button>
        <button id="nextBtn" class="ghost" disabled>عبور</button>
        <button id="restartBtn" class="ghost" disabled>شروع مجدد</button>
      </div>

    </div>
  </main>

  <div class="admin-panel" id="adminPanel" aria-hidden="true">
    <button id="closeAdminBtn" class="close-btn ghost">خروج از پنل</button>
    <div class="admin-left">
      <h3>پنل مدیریت</h3>
      <div class="field">
        <label>زمان مسابقه</label>
        <div class="row">
          <button class="timeOpt" data-sec="30">۳۰ ثانیه</button>
          <button class="timeOpt" data-sec="60">۶۰ ثانیه</button>
          <button class="timeOpt" data-sec="90">۹۰ ثانیه</button>
        </div>
        <div style="margin-top:8px" class="row">
          <input id="customSeconds" type="number" placeholder="زمان دلخواه (ثانیه)" min="5" />
          <button id="applyCustom" class="ghost">اعمال</button>
        </div>
      </div>

      <div class="field">
        <label>سطح دشواری</label>
        <div class="row">
          <button id="easyBtn" data-diff="easy">آسان</button>
          <button id="mediumBtn" data-diff="medium">متوسط</button>
          <button id="hardBtn" data-diff="hard">سخت</button>
        </div>
      </div>

      <div class="field">
        <label>لیست گروه (أَفْعَلَ - یُفْعِل - اِفعال)</label>
        <textarea id="list-ifaal"></textarea>
        <div class="small muted">هر فعل در یک خط قرار بگیرد یا با ویرگول جدا شود.</div>
      </div>

      <div class="row">
        <button id="saveLists">ذخیره لیست‌ها</button>
        <button id="resetLists" class="ghost">بازنشانی لیست‌ها</button>
        <button id="resetAll" class="ghost">ریست کامل</button>
      </div>
    </div>

    <div class="admin-right">
      <div>
        <label>لیست گروه (فَعَّلَ - یُفَعِّل - تَفعیل)</label>
        <textarea id="list-tafeil"></textarea>
      </div>

      <div>
        <label>لیست گروه (فاعَل - یُفاعِلُ - مُفاعَلَة)</label>
        <textarea id="list-mufaala"></textarea>
      </div>

      <hr style="margin:8px 0">

      <h3>امتیازات ثبت‌شده</h3>
      <div class="score-list" id="scoreList"></div>

      <div class="footer-actions">
        <button id="clearScores" class="ghost">پاک کردن امتیازات</button>
        <button id="exportExcel" class="ghost">خروجی اکسل</button>
      </div>

    </div>

  </div>

</div>

<div class="modal" id="nameModal" role="dialog" aria-modal="true">
  <div class="modal-card" role="document">
    <h3>زمان به پایان رسید</h3>
    <p class="muted">امتیاز شما: <strong id="finalScore">۰</strong> | درست: <strong id="finalCorrect">۰</strong> | غلط: <strong id="finalWrong">۰</strong></p>
    <div style="margin-top:8px;text-align:center">
      <label>نام دانش آموز</label>
      <input id="playerName" type="text" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef6ff;font-family:'Vazir';font-size:16px" placeholder="اسم را وارد کنید..." />
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:center">
      <button id="saveScoreBtn">ذخیره امتیاز</button>
      <button id="dismissModal" class="ghost">انصراف</button>
    </div>
  </div>
</div>

<div id="topError" class="top-error" role="alert" aria-live="assertive"></div>

<audio id="correctSound" src="data:audio/mpeg;base64,/+NIxAAAAAAAAAAAAAAA/+NIxAAAAAAAAMz///////////////////8AAAAA/+MYxAAAAAAAAMz///////////////////8AAAAA"></audio> <!-- Placeholder for correct sound -->

<audio id="wrongSound" src="data:audio/mpeg;base64,/+NIxAAAAAAAAAAAAAAA/+NIxAAAAAAAAMz///////////////////8AAAAA/+MYxAAAAAAAAMz///////////////////8AAAAA"></audio> <!-- Placeholder for wrong sound -->

<script>
/* ======= دادهٔ اولیه ======= */
const defaultData = {
  ifaal: [
"أَعْطَی","أَكْرَمَ","أَجْرَى","أَخْرَجَ","أَخْفَى","أَرْسَلَ","أَحْيی","أَبْطَلَ","أَلْقى","أَحْضَرَ","أَهْدَى","أَسْرَعَ","أَفْشى","أَحْرَقَ","أَلغی","أَعْلَقَ","أَنْسى","أَلْهَمَ","أَغْنى","أَثْبَتَ","أَحَس","أَشارَ","أَطاع","أَمَدَّ","أَقَرَّ","أَدارَ","أَتَمَّ","أَرادَ","أَصَرَّ","أَقامَ","أَحَبَّ","أَجابَ","أَلَحَّ","أَضافَ","أَحَلَّ","أَعادَ","أَسَرَّ","أَخَافَ","أَقَلَّ","أَهَانَ"
  ],
  tafeil: [
"فَكَّر","عَلَّمَ","شَوَّقَ","كَذَّبَ","وَضَّحَ","وَلَّدَ","غَيَّرَ","دَبَّرَ","هَدَّدَ","عَرَّفَ","غَطّى","رَبّى","زَكّى","صَلّى","قَوّى","أَدّى","سَمّى","سَلّى","غَدَّى","حَيَّى"
  ],
  mufaala: [
"شَاهَدَ","عانَقَ","صافَحَ","راقَبَ","لاحَظَ","زاحَمَ","وَافَقَ","خَالَفَ","سافَرَ","عالَجَ","ساعَدَ","نادى","ساوى","جازى","عانى","حامى","لاقى","ناجى","راعى","عافى","باهى","دارى"
  ]
};
/* ======= کلیدهای localStorage ======= */
const STORAGE = {
  lists: 'verbGame:lists',
  scores:'verbGame:scores',
  settings:'verbGame:settings'
};
/* ======= وضعیت بازی ======= */
let lists = null;
let scores = [];
let settings = { defaultTime: 60, difficulty: 'medium' };
let current = {
  timeLeft: 0,
  timerId: null,
  running:false,
  score:0,
  qCount:0,
  correctCount:0,
  wrongCount:0,
  hearts: 3,
  currentVerb:null,
  currentAnswer:null
};
/* ======= ابزارهای ذخیره/بارگذاری ======= */
function saveJSON(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function loadJSON(key, fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback }catch(e){return fallback}}
function loadLists(){ const saved = loadJSON(STORAGE.lists, null); return saved || JSON.parse(JSON.stringify(defaultData)); }
function saveLists(){ saveJSON(STORAGE.lists, lists); }
/* ======= المان‌ها ======= */
const intro = document.getElementById('intro');
const wrap = document.querySelector('.wrap');
const verbDisplay = document.getElementById('verbDisplay');
const answersEl = document.getElementById('answers');
const timeLeftEl = document.getElementById('timeLeft');
const scoreEl = document.getElementById('score');
const qCountEl = document.getElementById('qCount');
const correctCountEl = document.getElementById('correctCount');
const wrongCountEl = document.getElementById('wrongCount');
const difficultyDisplay = document.getElementById('difficultyDisplay');
const heartsEl = document.getElementById('hearts');
const heart1 = document.getElementById('heart1');
const heart2 = document.getElementById('heart2');
const heart3 = document.getElementById('heart3');
const startPanel = document.getElementById('startPanel');
const startBtn = document.getElementById('startBtn');
const countdownEl = document.getElementById('countdown');
const controls = document.getElementById('controls');
const pauseBtn = document.getElementById('pauseBtn');
const nextBtn = document.getElementById('nextBtn');
const restartBtn = document.getElementById('restartBtn');
const adminPanel = document.getElementById('adminPanel');
const closeAdminBtn = document.getElementById('closeAdminBtn');
const listIfaal = document.getElementById('list-ifaal');
const listTafeil = document.getElementById('list-tafeil');
const listMufaala = document.getElementById('list-mufaala');
const saveListsBtn = document.getElementById('saveLists');
const resetListsBtn = document.getElementById('resetLists');
const scoreList = document.getElementById('scoreList');
const clearScoresBtn = document.getElementById('clearScores');
const exportExcelBtn = document.getElementById('exportExcel');
const timeOptBtns = document.querySelectorAll('.timeOpt');
const customSeconds = document.getElementById('customSeconds');
const applyCustom = document.getElementById('applyCustom');
const resetAllBtn = document.getElementById('resetAll');
const nameModal = document.getElementById('nameModal');
const finalScoreEl = document.getElementById('finalScore');
const finalCorrectEl = document.getElementById('finalCorrect');
const finalWrongEl = document.getElementById('finalWrong');
const playerNameInput = document.getElementById('playerName');
const saveScoreBtn = document.getElementById('saveScoreBtn');
const dismissModal = document.getElementById('dismissModal');
const mainPanel = document.getElementById('mainPanel');
const correctSound = document.getElementById('correctSound');
const wrongSound = document.getElementById('wrongSound');
const topErrorEl = document.getElementById('topError');
/* ======= مقداردهی اولیه پنل از داده‌ها ======= */
function populateTextareas(){
  listIfaal.value = lists.ifaal.join('\n');
  listTafeil.value = lists.tafeil.join('\n');
  listMufaala.value = lists.mufaala.join('\n');
}
/* ======= رندر امتیازها و نمایش اولیه ======= */
function renderScores(){
  scoreList.innerHTML = '';
  if(!scores || scores.length===0){ scoreList.innerHTML = '<div class="log-item muted">هیچ امتیازی ثبت نشده</div>'; return; }
  scores.sort((a,b) => b.score - a.score).slice(0,200).forEach((s, idx)=>{
    const div = document.createElement('div');
    div.className = 'score-item';
    const left = document.createElement('div');
    left.innerHTML = `<strong>#${idx+1} ${escapeHtml(s.name)}</strong> — <span class="muted">${new Date(s.time).toLocaleString('fa-IR')}</span>`;
    const right = document.createElement('div');
    right.innerHTML = `<strong>${toPersianNum(s.score)}</strong> (درست: ${s.correct}, غلط: ${s.wrong})`;
    div.appendChild(left); div.appendChild(right);
    scoreList.appendChild(div);
  });
}
/* ======= انیمیشن intro: منتظر کلیک باشد ======= */
function runIntroSequence(){
  intro.classList.remove('hidden');
  intro.style.display = 'flex';
  void intro.offsetWidth;
  intro.style.opacity = '1';
  wrap.style.opacity = '0';
  wrap.style.transform = 'translateY(6px)';
  const finishIntro = () => {
    intro.style.animation = 'fadeOut 0.8s ease-in-out';
    setTimeout(() => {
      intro.classList.add('hidden');
      intro.setAttribute('aria-hidden','true');
      intro.style.display = 'none';
      intro.style.animation = '';
    }, 800);
    wrap.style.opacity = '1';
    wrap.style.transform = 'translateY(0)';
    mainPanel.classList.add('visible');
    mainPanel.setAttribute('aria-hidden','false');
    showStartPanel(true); // first time
  };
  function onClick(){
    finishIntro();
    intro.removeEventListener('click', onClick);
    intro.removeEventListener('touchend', onClick);
  }
  intro.addEventListener('click', onClick);
  intro.addEventListener('touchend', onClick); // برای موبایل
}
if(document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', runIntroSequence); } else { runIntroSequence(); }
/* ======= منطق بازی ======= */
const persianDigits = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
function toPersianNum(num){
  return String(num).split('').map(d => { return /\d/.test(d) ? persianDigits[Number(d)] : d; }).join('');
}
function formatTime(sec){
  const m = Math.floor(sec/60).toString().padStart(2,'0');
  const s = (sec%60).toString().padStart(2,'0');
  return `${toPersianNum(m)}:${toPersianNum(s)}`;
}
function setTimeDisplay(sec){
  timeLeftEl.textContent = formatTime(Math.max(0, Math.floor(Number(sec) || 0)));
  if(Number(sec) <= 10){ timeLeftEl.classList.add('urgent'); } else { timeLeftEl.classList.remove('urgent'); }
}
function setScoreDisplay(n){ scoreEl.textContent = toPersianNum(n); }
function setQCount(n){ qCountEl.textContent = toPersianNum(n); }
function setCorrectCount(n){ correctCountEl.textContent = toPersianNum(n); }
function setWrongCount(n){ wrongCountEl.textContent = toPersianNum(n); }
function setDifficultyDisplay(){ difficultyDisplay.textContent = settings.difficulty === 'easy' ? 'آسان' : settings.difficulty === 'medium' ? 'متوسط' : 'سخت'; }
function updateHearts(){
  if(settings.difficulty !== 'hard'){ heartsEl.style.display = 'none'; return; }
  heartsEl.style.display = 'flex';
  [heart1, heart2, heart3].forEach((h, idx) => { h.classList.toggle('empty', idx >= current.hearts); });
}
function escapeHtml(str){ return String(str).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }
function getRandomVerb(previous){
  const keys = Object.keys(lists).filter(k => lists[k] && lists[k].length>0);
  if(keys.length===0) return null;
  const all = [];
  keys.forEach(k => lists[k].forEach(v => all.push({v,group:k})));
  if(all.length === 1) return all[0];
  let idx;
  do { idx = Math.floor(Math.random()*all.length); } while(previous && all[idx].v === previous);
  return all[idx];
}
function shuffle(array) { return array.sort(() => Math.random() - 0.5); }
function renderAnswers() {
  const options = [
    {answer: 'ifaal', text: '<span>أَفْعَلَ</span><span>يُفْعِلُ</span><span>إِفْعَال</span>'},
    {answer: 'tafeil', text: '<span>فَعَّلَ</span><span>يُفَعِّلُ</span><span>تَفْعِيل</span>'},
    {answer: 'mufaala', text: '<span>فَاعَلَ</span><span>يُفَاعِلُ</span><span>مُفَاعَلَة</span>'}
  ];
  const shuffled = shuffle(options.slice());
  answersEl.innerHTML = shuffled.map((opt, idx) => `
    <div class="card touch-friendly" data-answer="${opt.answer}" role="button" tabindex="0">
      <div class="badge">${toPersianNum(idx + 1)}</div>
      <div class="card-text">${opt.text}</div>
    </div>
  `).join('');
}
function startCountdown(callback) {
  startBtn.style.display = 'none';
  countdownEl.style.display = 'block';
  let count = 3; // changed to 3 seconds
  countdownEl.textContent = toPersianNum(count);
  const interval = setInterval(() => {
    count--;
    countdownEl.textContent = toPersianNum(count);
    if (count <= 0) {
      clearInterval(interval);
      countdownEl.style.display = 'none';
      callback();
    }
  }, 1000);
}
function startGame(){
  if(current.running) return;
  hideStartPanel();
  current.timeLeft = settings.defaultTime || 60;
  current.score = 0;
  current.qCount = 0;
  current.correctCount = 0;
  current.wrongCount = 0;
  current.hearts = 3;
  current.running = true;
  setTimeDisplay(current.timeLeft);
  setScoreDisplay(current.score);
  setQCount(current.qCount);
  setCorrectCount(current.correctCount);
  setWrongCount(current.wrongCount);
  setDifficultyDisplay();
  updateHearts();
  controls.style.display = 'flex';
  pauseBtn.disabled = false;
  nextBtn.disabled = false;
  restartBtn.disabled = false;
  nextQuestion();
  clearInterval(current.timerId);
  current.timerId = setInterval(()=>{
    current.timeLeft--;
    setTimeDisplay(current.timeLeft);
    if(current.timeLeft<=0){ endGame(); }
  },1000);
}
function pauseGame(){
  if(!current.running) return;
  clearInterval(current.timerId);
  current.timerId = null;
  current.running = false;
  pauseBtn.disabled = true;
}
function endGame(){
  clearInterval(current.timerId);
  current.running = false;
  current.timerId = null;
  pauseBtn.disabled = true;
  nextBtn.disabled = true;
  restartBtn.disabled = true;
  finalScoreEl.textContent = toPersianNum(current.score);
  finalCorrectEl.textContent = toPersianNum(current.correctCount);
  finalWrongEl.textContent = toPersianNum(current.wrongCount);
  playerNameInput.value = '';
  nameModal.classList.add('open');
}
function nextQuestion(){
  document.querySelectorAll('.card').forEach(c=> c.classList.remove('correct','wrong','disabled'));
  const prev = current.currentVerb;
  const item = getRandomVerb(prev);
  if(!item){
    verbDisplay.textContent = 'هیچ فعلی موجود نیست';
    current.currentVerb = null;
    current.currentAnswer = null;
    return;
  }
  current.currentVerb = item.v;
  current.currentAnswer = item.group;
  verbDisplay.textContent = item.v;
  renderAnswers();
}
answersEl.addEventListener('click', handleAnswer);
answersEl.addEventListener('touchend', handleAnswer); // بهبود برای موبایل
function handleAnswer(e) {
  if(!current.running) return;
  const card = e.target.closest('.card');
  if(!card || card.classList.contains('disabled')) return;
  const user = card.dataset.answer;
  const correct = current.currentAnswer;
  if(user === correct){
    card.classList.add('correct');
    current.score += 10;
    current.correctCount++;
    correctSound.play();
  } else {
    card.classList.add('wrong');
    current.wrongCount++;
    if(settings.difficulty === 'easy'){
      // بدون کم کردن امتیاز
    } else if(settings.difficulty === 'medium'){
      current.score -= 3; // جریمه برای غلط
    } else if(settings.difficulty === 'hard'){
      current.hearts--;
      updateHearts();
      if(current.hearts <= 0){
        endGame();
        return;
      }
    }
    wrongSound.play();
  }
  current.qCount++;
  setScoreDisplay(current.score);
  setQCount(current.qCount);
  setCorrectCount(current.correctCount);
  setWrongCount(current.wrongCount);
  document.querySelectorAll('.card').forEach(c=> c.classList.add('disabled'));
  setTimeout(() => { if(current.running) nextQuestion(); }, 520);
}
/* ======= امتیازدهی ======= */
function saveScore(name){
  const rec = {
    name: name||'ناشناس',
    score: current.score,
    correct: current.correctCount,
    wrong: current.wrongCount,
    qCount: current.qCount,
    time: new Date().toISOString(),
    duration: settings.defaultTime,
    difficulty: settings.difficulty
  };
  scores.unshift(rec);
  saveJSON(STORAGE.scores, scores);
  renderScores();
}
/* ======= پنل مدیریت: تعاملات ======= */
let spaceCount = 0;
let spaceTimer = null;
document.addEventListener('keydown', (e) => {
  const tag = document.activeElement && document.activeElement.tagName;
  if(tag === 'INPUT' || tag === 'TEXTAREA') return;
  if (e.code === 'Space') {
    e.preventDefault();
    spaceCount++;
    if (spaceCount === 1) {
      spaceTimer = setTimeout(() => { spaceCount = 0; }, 3000);
    }
    if (spaceCount >= 5) {
      clearTimeout(spaceTimer);
      spaceCount = 0;
      if(!isMobile()) {
        if(current.running){
          showTopError('نمیتوان وسط بازی پنل مدیریت را باز کرد !');
        } else {
          toggleAdminPanel();
        }
      }
    }
  }
  if(e.key === 'Escape'){
    if(adminPanel.classList.contains('open')){ toggleAdminPanel(); }
    if(nameModal.classList.contains('open')) nameModal.classList.remove('open');
  }
});
function toggleAdminPanel() {
  if (adminPanel.classList.contains('open')) {
    adminPanel.style.animation = 'fadeOut 0.4s ease';
    setTimeout(() => {
      adminPanel.classList.remove('open');
      adminPanel.setAttribute('aria-hidden', 'true');
      adminPanel.style.animation = '';
      adminPanel.style.display = 'none';
    }, 400);
  } else {
    adminPanel.style.display = 'grid';
    adminPanel.style.animation = 'fadeIn 0.4s ease';
    adminPanel.classList.add('open');
    adminPanel.setAttribute('aria-hidden', 'false');
    populateTextareas();
    renderScores();
    updateActiveButtons();
  }
}
function isMobile() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 600;
}
if(isMobile()) {
  const adminBtn = document.createElement('button');
  adminBtn.textContent = 'پنل مدیریت';
  adminBtn.classList.add('ghost');
  adminBtn.style.position = 'fixed';
  adminBtn.style.bottom = '20px';
  adminBtn.style.left = '50%';
  adminBtn.style.transform = 'translateX(-50%)';
  document.body.appendChild(adminBtn);
  adminBtn.addEventListener('click', () => {
    toggleAdminPanel();
  });
  closeAdminBtn.addEventListener('click', () => {
    toggleAdminPanel();
  });
}
saveListsBtn.addEventListener('click', ()=>{
  lists.ifaal = parseList(listIfaal.value);
  lists.tafeil = parseList(listTafeil.value);
  lists.mufaala = parseList(listMufaala.value);
  saveLists();
  populateTextareas();
  alert('لیست‌ها ذخیره شدند.');
});
resetListsBtn.addEventListener('click', ()=>{
  if(!confirm('آیا مطمئنی لیست‌ها به حالت پیش‌فرض بازنشانی شود؟')) return;
  lists = JSON.parse(JSON.stringify(defaultData));
  saveLists();
  populateTextareas();
  alert('لیست‌ها بازنشانی شدند.');
});
clearScoresBtn.addEventListener('click', ()=>{
  if(!confirm('پاک کردن تمام امتیازات؟')) return;
  scores = [];
  saveJSON(STORAGE.scores, scores);
  renderScores();
});
resetAllBtn.addEventListener('click', ()=>{
  if(!confirm('ریست کامل: همهٔ داده‌ها (لیست‌ها، امتیاز) پاک شود؟')) return;
  localStorage.removeItem(STORAGE.lists);
  localStorage.removeItem(STORAGE.scores);
  localStorage.removeItem(STORAGE.settings);
  lists = JSON.parse(JSON.stringify(defaultData));
  scores = [];
  settings = {defaultTime:60, difficulty: 'medium'};
  populateTextareas();
  renderScores();
  setTimeDisplay(settings.defaultTime);
  alert('بازنشانی کامل انجام شد.');
});
/* ======= زمان بندی / گزینه‌ها ======= */
timeOptBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const s = parseInt(btn.dataset.sec,10);
    settings.defaultTime = s;
    saveJSON(STORAGE.settings, settings);
    setTimeDisplay(settings.defaultTime);
    updateActiveButtons();
  });
});
applyCustom.addEventListener('click', ()=>{
  const v = parseInt(customSeconds.value,10);
  if(isNaN(v) || v<5){ alert('لطفاً یک عدد صحیح (حداقل 5 ثانیه) وارد کن'); return; }
  settings.defaultTime = v;
  saveJSON(STORAGE.settings, settings);
  setTimeDisplay(settings.defaultTime);
  updateActiveButtons();
});
/* ======= سختی از پنل مدیریت ======= */
const difficultyBtns = [document.getElementById('easyBtn'), document.getElementById('mediumBtn'), document.getElementById('hardBtn')];
difficultyBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    settings.difficulty = btn.dataset.diff;
    saveJSON(STORAGE.settings, settings);
    updateActiveButtons();
    updateHearts();
  });
});
function updateActiveButtons() {
  timeOptBtns.forEach(btn => btn.classList.remove('active'));
  const activeTimeBtn = Array.from(timeOptBtns).find(btn => parseInt(btn.dataset.sec) === settings.defaultTime);
  if (activeTimeBtn) activeTimeBtn.classList.add('active');
  difficultyBtns.forEach(btn => btn.classList.remove('active'));
  const activeDiffBtn = difficultyBtns.find(btn => btn.dataset.diff === settings.difficulty);
  if (activeDiffBtn) activeDiffBtn.classList.add('active');
}
/* ======= دکمه‌های پوز/بعدی/ریستارت ======= */
pauseBtn.addEventListener('click', ()=>{ pauseGame(); });
nextBtn.addEventListener('click', ()=>{ if(!current.running) return; nextQuestion(); });
restartBtn.addEventListener('click', ()=>{ if(confirm('شروع مجدد بازی؟')) resetToIdle(true); });
/* ======= نمایش/مخفی کردن پنل شروع ======= */
function showStartPanel(firstTime = false){
  startPanel.style.display = 'flex';
  startBtn.style.display = 'block';
  countdownEl.style.display = 'none';
}
function hideStartPanel(){
  startPanel.style.display = 'none';
}
/* ======= شروع بازی از پنل شروع ======= */
startBtn.addEventListener('click', () => {
  startCountdown(startGame);
});
/* ======= ذخیره نام بازیکن ======= */
saveScoreBtn.addEventListener('click', ()=>{
  const name = (playerNameInput.value || '').trim() || 'ناشناس';
  saveScore(name);
  nameModal.classList.remove('open');
  resetToIdle(true);
});
dismissModal.addEventListener('click', ()=>{ nameModal.classList.remove('open'); resetToIdle(true); });
function resetToIdle(useCountdown = false){
  clearInterval(current.timerId);
  current.timerId = null;
  current.running = false;
  current.score = 0; current.qCount = 0; current.correctCount = 0; current.wrongCount = 0; current.hearts = 3; current.timeLeft = settings.defaultTime || 60;
  setScoreDisplay(current.score); setQCount(current.qCount); setCorrectCount(current.correctCount); setWrongCount(current.wrongCount); setTimeDisplay(current.timeLeft);
  updateHearts();
  answersEl.innerHTML = '';
  verbDisplay.textContent = '';
  controls.style.display = 'none';
  if (useCountdown) {
    mainPanel.classList.add('visible');
    mainPanel.setAttribute('aria-hidden','false');
    showStartPanel(false);
  } else {
    mainPanel.classList.remove('visible');
    mainPanel.setAttribute('aria-hidden','true');
    runIntroSequence();
  }
}
/* ======= هِلفِرها ======= */
function parseList(text){ return text.split(/[\n,؛،]+/).map(s=>s.trim()).filter(Boolean); }
/* ======= خروجی اکسل (CSV) ======= */
exportExcelBtn.addEventListener('click', ()=>{
  if(!scores || scores.length===0){ alert('هیچ امتیازی برای خروجی وجود ندارد'); return; }
  const headers = ['name','score','correct','wrong','qCount','time','duration','difficulty'];
  const rows = scores.map(s => headers.map(h => String(s[h] === undefined ? '' : s[h]).replace(/"/g, '""')).map(cell => `"${cell}"`).join(','));
  const csv = [headers.join(',')].concat(rows).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'scores.csv';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
});
/* ======= بارگذاری اولیه از localStorage ======= */
function initFromStorage(){
  lists = loadLists();
  populateTextareas();
  scores = loadJSON(STORAGE.scores, []);
  settings = loadJSON(STORAGE.settings, settings) || settings;
  renderScores();
  const s = settings.defaultTime || 60;
  setTimeDisplay(s);
  mainPanel.classList.remove('visible');
  mainPanel.setAttribute('aria-hidden','true');
  updateActiveButtons();
  updateHearts();
}
initFromStorage();
/* ======= نمایش خطا در بالا (توست) ======= */
function showTopError(msg, timeout = 2500){
  topErrorEl.textContent = msg;
  topErrorEl.style.display = 'block';
  setTimeout(()=>{ topErrorEl.style.display = 'none'; }, timeout);
}
</script>

</body>

</html>
